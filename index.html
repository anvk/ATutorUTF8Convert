<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Drag and Drop Multiple ATutor language packages</title>
	<link href="resources/styles/global.css" rel="stylesheet" type="text/css">
</head>
<body>
	<div class="container"> 
		<p>
			<a href="archive/">Archive with all converted lang packages could be found here</a>. 
		</p>
		<div id="up_txt">
			
		</div>
		<div id="dropzone" style="min-height: 500px;"><div id="def_text">Drop files here</div></div>
	</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="http://code.google.com/apis/gears/gears_init.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
$(function() {
    
    // We cannot use $.bind() since jQuery does not normalize the native events.
    $('#dropzone')
        .get(0)
        .addEventListener('drop', upload, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragenter', function(event) { 
                $('#dropzone').css("background-color", "#ffc");
            }, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragexit', function(event) { 
                $('#dropzone').css("background-color", "#fff");
            }, false);
    $('#dropzone')
        .get(0)
        .addEventListener('dragover', function(event) { 
                event.preventDefault(); 
            }, false);
    
    function upload(event) {
        var that = this;				// EXAMPLE WHERE WE NEED TO USE 'THAT' instead of 'this' in order to make filenum variable accessible in closure.
        var data = event.dataTransfer;
		
        // Show spinner for each dropped file.
        var output = [];
        for (var i = 0; i < data.files.length; i++) {
        	output.push('<li><strong>', data.files[i].name, '</strong> (', data.files[i].type || 'n/a', ') - ',
                  data.files[i].size, ' bytes, last modified: ',
                  data.files[i].lastModifiedDate.toLocaleDateString(), '<img src="resources/images/spinner.gif" width="16" height="16" /></li>');
        }
        that.filenum = data.files.length;
        $('#dropzone').append($('<ul>' + output.join('') + '</ul>'));
        
        // Building request for multiple file drag and drop.
        var xhr = new XMLHttpRequest()
        
		var formData = new FormData();
		for (var i = 0; i < data.files.length; i++) {
			var file = data.files[i];
			formData.append('user_file[]', file);
		}           

		xhr.open('POST', 'lib/doUpload.php', true);
		xhr.send(formData);
		
		xhr.onload = function(event) {
    		// If we got an error display it.
    		if (xhr.responseText) {
        		alert(xhr.responseText);
    		}
    		// Make background back to white, say how many files converted.
    		$('#dropzone').css('background-color', '#fff');
    		$('#dropzone').empty();
    		$('#dropzone').append($('<div id="def_text">Drop files here</div>'));
    		$('#up_txt').empty();
    		$('#up_txt').append($('<div id="def_text">Converted: '+ that.filenum +' files</div>'));
		}; 
        
        event.stopPropagation();
    }
});
</script>      
</body>
</html>